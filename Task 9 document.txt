#!/bin/bash

# Variables for remote server access
REMOTE_USER="somasundaram_m"       (your user me)  
REMOTE_HOST="10.128.0.16"
REMOTE_PASSWORD="Sundar@12"      (passd change must) 

# Define the Slack webhook URL and email details
SLACK_WEBHOOK_URL="https://hooks.slack.com/services/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"
TO_EMAIL="sundar2023m@gmail.com"
FROM_EMAIL="somasundaram.m@thecloudside.com"
SUBJECT="System Metrics Report"

# Function to execute commands on the remote server
remote_exec() {
    sshpass -p $REMOTE_PASSWORD ssh -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST "$1"
}

# Get system uptime
uptime_info=$(remote_exec "uptime -p")

# Get CPU usage
cpu_usage=$(remote_exec "top -bn1 | grep 'Cpu(s)' | sed 's/.*, *\\([0-9.]*\\)%* id.*/\\1/' | awk '{print 100 - \$1\"%\"}'")

# Get memory usage
memory_usage=$(remote_exec "free -m | awk 'NR==2{printf \"Memory Usage: %s/%sMB (%.2f%%)\", \$3,\$2,\$3*100/\$2 }'")

# Get top CPU consuming process
top_cpu_process=$(remote_exec "ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%cpu | head -n 2 | tail -n 1")

# Get disk space usage
disk_usage=$(remote_exec "df -h | grep '^/dev/' | awk '{ print \$5 \" \" \$1 }'")

# Create the message payload for Slack
payload=$(cat <<EOF
{
    "text": "System Metrics Report",
    "attachments": [
        {
            "title": "System Uptime",
            "text": "$(echo "$uptime_info" | sed 's/"/\\"/g')"
        },
        {
            "title": "CPU Usage",
            "text": "$(echo "$cpu_usage" | sed 's/"/\\"/g')"
        },
        {
            "title": "Memory Usage",
            "text": "$(echo "$memory_usage" | sed 's/"/\\"/g')"
        },
        {
            "title": "Top CPU Consuming Process",
            "text": "$(echo "$top_cpu_process" | sed 's/"/\\"/g')"
        },
        {
            "title": "Disk Usage",
            "text": "$(echo "$disk_usage" | sed 's/"/\\"/g')"
        }
    ]
}
EOF
)

# Send the payload to Slack
curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL

# Create the email content
email_content=$(cat <<EOF
System Metrics Report

System Uptime: $uptime_info
CPU Usage: $cpu_usage
Memory Usage: $memory_usage
Top CPU Consuming Process: $top_cpu_process
Disk Usage: $disk_usage
EOF
)

# Send the email
echo "$email_content" | mail -s "$SUBJECT" -r "$FROM_EMAIL" "$TO_EMAIL"



set up smtp configuration

	sudo apt update
        sudo apt install mailx ssmtp

	/etc/ssmtp/ssmtp.conf

	root=your-email@gmail.com (uour mail)
	mailhub=smtp.gmail.com:587
	AuthUser=your-email@gmail.com(your mail)
	AuthPass=your-email-password(app specific password)
	UseTLS=YES
	UseSTARTTLS=YES
	hostname=your-server-hostname

	echo "This is a test email" | mailx -s "Test Email" your mail@gmail.com

Slack want to create 

Slack app and  webbook

Launch another vm and place the script  (launch in same network)
  apt install sshpass 
  


